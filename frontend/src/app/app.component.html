<div class="min-h-screen flex flex-col">
  <app-header />

  <main class="flex-1 max-w-5xl mx-auto w-full px-6 py-8 md:py-12">
    @if (hasResults() && appState() !== "validating") {
      <div class="mb-6 flex justify-center">
        <div
          class="paper-card results-surface p-1.5 inline-flex items-center gap-1"
        >
          <button
            type="button"
            class="px-4 py-2 rounded-md text-sm font-sans transition-colors flex items-center gap-2"
            [class.bg-parchment-100]="appState() === 'upload'"
            [class.text-ink-900]="appState() === 'upload'"
            [class.text-ink-600]="appState() !== 'upload'"
            (click)="goToValidation()"
          >
            <lucide-icon name="file-check" class="w-4 h-4"></lucide-icon>
            Validate
          </button>

          <button
            type="button"
            class="px-4 py-2 rounded-md text-sm font-sans transition-colors flex items-center gap-2"
            [class.bg-parchment-100]="appState() === 'results'"
            [class.text-ink-900]="appState() === 'results'"
            [class.text-ink-600]="appState() !== 'results'"
            (click)="goToResults()"
          >
            <lucide-icon name="book-open" class="w-4 h-4"></lucide-icon>
            Results
          </button>
        </div>
      </div>
    }

    @switch (appState()) {
      @case ("upload") {
        <div class="space-y-4">
          <app-file-upload (fileChange)="onFileChange($event)" />

          <div class="flex justify-end">
            <button
              type="button"
              class="btn-secondary inline-flex items-center gap-2"
              (click)="openRuleSettings()"
            >
              <lucide-icon name="settings" class="w-4 h-4"></lucide-icon>
              Rule Settings
            </button>
          </div>
        </div>

        <div
          class="fixed inset-0 z-50 px-4 py-6 md:p-8 bg-ink-950/45 backdrop-blur-[1px]"
          [class.hidden]="!ruleSettingsOpen()"
          (click)="closeRuleSettings()"
        >
          <div
            class="max-w-3xl mx-auto h-full flex items-start justify-center"
            (click)="$event.stopPropagation()"
          >
            <div
              class="paper-card results-surface w-full max-h-full overflow-y-auto p-4 md:p-5"
            >
              <div class="flex items-center justify-between mb-3">
                <div>
                  <h3 class="font-display text-lg font-semibold text-ink-900">
                    Rule Settings
                  </h3>
                  <p class="font-sans text-xs text-ink-500 mt-0.5">
                    {{ draftSelectedRules().length }}/{{
                      totalRuleCount()
                    }}
                    selected
                  </p>
                </div>
                <button
                  type="button"
                  class="p-2 rounded-md text-ink-500 hover:text-ink-800 hover:bg-parchment-100 transition-colors"
                  (click)="closeRuleSettings()"
                  aria-label="Close rule settings"
                >
                  <lucide-icon name="x" class="w-4 h-4"></lucide-icon>
                </button>
              </div>

              <app-rule-selector
                [selectedRuleNames]="selectedRules()"
                [syncKey]="ruleSelectorSyncKey()"
                (rulesChange)="onRulesChange($event)"
                (selectionCountChange)="onRuleCountChange($event)"
              />

              <div
                class="mt-4 pt-3 border-t border-parchment-200/70 flex items-center justify-end gap-2"
              >
                <button
                  type="button"
                  class="btn-secondary"
                  (click)="closeRuleSettings()"
                >
                  Cancel
                </button>
                <button
                  type="button"
                  class="btn-primary px-5 py-2.5 text-sm"
                  [disabled]="draftSelectedRules().length === 0"
                  [class.opacity-50]="draftSelectedRules().length === 0"
                  [class.cursor-not-allowed]="draftSelectedRules().length === 0"
                  (click)="applyRuleSettings()"
                >
                  Apply
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Validate Button -->
        <div class="mt-8 flex justify-center">
          <button
            type="button"
            class="btn-primary flex items-center gap-3 text-lg px-8 py-4"
            [disabled]="!canValidate()"
            [class.opacity-50]="!canValidate()"
            [class.cursor-not-allowed]="!canValidate()"
            (click)="validateDocument()"
          >
            <lucide-icon name="file-check" class="w-5 h-5"></lucide-icon>
            Validate Thesis
          </button>
        </div>

        <!-- Validation hint -->
        @if (!canValidate()) {
          <p class="text-center font-sans text-sm text-ink-500 mt-4">
            @if (!selectedFile()) {
              Upload a .docx file to begin validation
            } @else if (selectedRules().length === 0) {
              Select at least one validation rule
            }
          </p>
        }
      }

      @case ("validating") {
        <app-validation-progress
          [steps]="validationSteps"
          [currentStep]="currentValidationStep()"
        />
      }

      @case ("results") {
        @if (validationResponse()) {
          <app-validation-results
            [response]="validationResponse()!"
            (onDownloadAnnotated)="downloadAnnotated()"
            (onReset)="reset()"
          />
        }
      }
    }

    <app-error-toast [message]="errorMessage()" (dismiss)="clearError()" />
  </main>

  <app-footer />
</div>
